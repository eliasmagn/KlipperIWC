# KlipperIWC Konzept

KlipperIWC ist eine schlanke Weboberfläche, die Statusinformationen und Steuerbefehle für eine Klipper-basierte 3D-Druckerinstallation bereitstellt. Die Anwendung stellt einen kleinen FastAPI-Service zur Verfügung, der neben einer HTTP-API auch Websocket-basierte Live-Updates ausliefert und perspektivisch um Integrationen in bestehende Drucker-Workflows erweitert wird. Benutzerverwaltung und Login sind bewusst nicht Teil des aktuellen Umfangs und werden erst in einer späteren Ausbaustufe berücksichtigt. Ziel ist eine wartbare, erweiterbare und für verschiedene Installationsziele (Bare Metal, virtuelle Maschine, Container) leicht deploybare Lösung.

Neue Board- und Druckerdefinitionen entstehen zunächst über Beiträge im GitHub-Repository. In einer späteren Phase mit Login-System sollen Anwender fehlende Hardware direkt während der Konfiguration ergänzen können. Als Zwischenschritt stehen eine neue Landingpage, der Board-Designer sowie ein interaktiver Drucker-Designer bereit. Der Drucker-Designer erlaubt Bild-Uploads, markiert Schalter, Extruder, Sensoren, Lüfter oder Stepper mittels Rechtecken, Kreisen und Maßpfeilen und nimmt Rotationsdistanzen für Antriebe auf. Eine korrigierte Koordinatenberechnung berücksichtigt die aktuelle ViewBox-Skalierung, sodass Markierungen exakt der Cursor-Position folgen. Beide Designer erzeugen angereicherte Visualisierungen, die unmittelbar als JSON-Dokumente gespeichert werden können. Dadurch lassen sich Definitionen dauerhaft versionieren, optional freigeben und später innerhalb des geplanten Konfigurations-Generators zusammenführen, der vollständige `klipper.conf`-Profile erzeugt.
Neue Board- und Druckerdefinitionen entstehen zunächst über Beiträge im GitHub-Repository. In einer späteren Phase mit Login-System sollen Anwender fehlende Hardware direkt während der Konfiguration ergänzen können. Als Zwischenschritt stehen eine neue Landingpage, der Board-Designer sowie ein interaktiver Drucker-Designer bereit. Der Drucker-Designer erlaubt Bild-Uploads, markiert Schalter, Extruder, Sensoren, Lüfter oder Stepper mittels Rechtecken, Kreisen und Maßpfeilen und nimmt Rotationsdistanzen für Antriebe auf. Beide Designer verfügen zusätzlich über einen 3D-CAD-Modus, der STEP-Dateien importiert, eine frei bewegliche Vorschau bereitstellt und Marker für Geräte, Führungen, Riemen, Kabel oder Sensorik direkt im Raum verankert. Die 3D-Markierungen werden gemeinsam mit den 2D-Annotationen verwaltet und ermöglichen es, räumliche Abhängigkeiten und Kabelwege bereits in der Entwurfsphase zu dokumentieren. Beide Designer erzeugen angereicherte Visualisierungen, die unmittelbar als JSON-Dokumente gespeichert werden können. Dadurch lassen sich Definitionen dauerhaft versionieren, optional freigeben und später innerhalb des geplanten Konfigurations-Generators zusammenführen, der vollständige `klipper.conf`-Profile erzeugt.

Für die Statuskommunikation existieren aktuell eine lesende HTTP-API (`/api/status`, `/api/jobs`, `/api/temperatures`) sowie ein Websocket-Gateway (`/ws/status`), die strukturierte Demo-Daten liefern und als Fundament für die Echtzeit-Anbindung dienen. Die entsprechenden Pydantic-Modelle bilden das Domain-Modell ab und können bei Bedarf unkompliziert erweitert werden. Eingehende Statuspakete werden zudem persistiert: Ein dedizierter Service-Layer legt Status-, Temperatur- und Job-Historien in SQLite ab, damit spätere Visualisierungen auf echte Verlaufsdaten zugreifen können. Ein periodischer Hintergrundjob sorgt dafür, dass Altdaten anhand einer konfigurierbaren Aufbewahrungsfrist automatisch bereinigt werden. Platzhalter für Authentifizierung und Rate-Limits erlauben es, Sicherheitsanforderungen in einer Folgestufe einzubauen, ohne den bestehenden Datenfluss zu verändern.

Ein neuer Upload- und Moderations-Workflow ermöglicht es, Board-Grafiken zentral zu speichern. Über `/api/board-assets` nehmen Uploads die Grafikdateien samt Metadaten entgegen, berechnen Prüfsummen und persistieren die Dateien über einen austauschbaren Storage-Layer (lokales Dateisystem oder S3-kompatible Buckets). Ergänzend dazu stehen die REST-Endpunkte `/api/definitions/boards` und `/api/definitions/printers` bereit, über die Designer-Ergebnisse dauerhaft in SQLite abgelegt werden. Die Tabellen hinterlegen Slugs, Beschreibungen, Vorschaulinks und das vollständige JSON der Definitionen. Service-Funktionen kapseln Speicherung, Konsistenzprüfungen und Zugriffskontrollen, wodurch sich spätere Integrationen in UI- oder Automatisierungs-Workflows vereinfachen.

Das Repository enthält zusätzlich ein versioniertes Registry-Verzeichnis für strukturierte Board-Definitionen. Die Dateien folgen dem Schema `schemas/board-definition.schema.json`, welches Pflichtfelder für Metadaten, Steckverbinder und Pins vorgibt und per `x-klipperiwc-version` versioniert ist. Ein dedizierter Service (`klipperiwc.services.board_registry`) und neue API-Routen (`/api/boards/*`) stellen sicher, dass Definitionen automatisiert validiert, aufgelistet und nach Revisionen gruppiert werden können. So lassen sich Design-Daten aus dem Board-Designer schrittweise in wiederverwendbare JSON-Definitionen überführen, bis ein vollwertiger UI-basierter Workflow bereitsteht.
Die Moderations-API erzwingt dabei einen abgestuften Zugriff: Öffentliche Endpunkte liefern ausschließlich geprüfte, freigegebene Assets, während Upload- und Moderator-Token erweiterten Zugriff auf Entwürfe und Warteschlangen gewähren. Dadurch lässt sich der Prüfprozess sauber vom öffentlichen Datenbestand trennen und dennoch nahtlos in bestehende Tools integrieren.
